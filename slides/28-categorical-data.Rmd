---
title: "Inference with Categorical Data"
subtitle: "MATH 250"
author: "Katie Fitzgerald, adpated from datasciencebox.org"
output:
  xaringan::moon_reader:
    css: ["xaringan-themer.css", "slides.css"]
    lib_dir: libs
    nature:
      ratio: "16:9"
      highlightLines: true
      highlightStyle: solarized-light
      countIncrementalSlides: false
---

```{r child = "setup.Rmd"}
```

```{r packages, echo = FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(kableExtra)
library(dsbox)
library(scales)
library(infer)
library(distributional)
library(ggdist)
```


class: middle

# Choosing the right analysis

---

## What do you want to do?

First step: Ask the following questions
  - What is the research question?
  - How many variables?
  - What type(s) of variable(s)?

Estimation -> Confidence interval

Decision -> Hypothesis test

---

class: middle

# Case study: What proportion of US adults are married?

---

## What proportion of US adults are married?

```{r, echo = FALSE}
set.seed(437)
survey <- data.frame(married = c(rep("yes", 530),
                                  rep("no", 470))) %>% 
  sample_n(1000)
```

+ How many variables? **1**
+ What type(s) of variable(s)? **categorical**

This is an **estimation** question, meaning a confidence interval is most appropriate. 

The parameter of interest is the **population proportion**, $p$, and the sample statistic is the sample proportion, $\hat{p}$

In 2019, a survey of 1,000 US adults age 25 - 54 found that 53% were married. 

```{r}
survey %>% 
  count(married) %>% 
  mutate(prop = n/sum(n))
```


---

# What proportion of US adults are married?

`prop_test()` will provide a confidence interval

```{r}
glimpse(survey)
prop_test(survey, response = married, success = "yes", 
          conf_level = 0.99)
```

We are 99% confident that the true proportion of US adults age 25 - 54 is between 0.489 and 0.571. 

---

# Case study: success of fertility treatment

Assisted Reproductive Technology (ART) is a collection of techniques that help facilitate pregnancy (e.g., in vitro fertilization). The 2018 ART Fertility Clinic Success Rates Report published by the Centers for Disease Control and Prevention reports that ART has been successful in leading to a live birth in 48.8% of cases where the patient is under 35 years old. A new fertility clinic claims that their success rate is higher than average for this age group. A random sample of 30 of their patients yielded a success rate of 60%. A consumer watchdog group would like to determine if this provides strong evidence to support the companyâ€™s claim.

+ Research question: **is the true success rate at the new clinic greater than 48.8%?**
+ How many variables? **1**
+ What type(s) of variables? **categorical**

This is a **hypothesis test** question about **one proportion**

---

## Hypothesis test for one proportion

```{r, echo = FALSE}
set.seed(437)
newclinic <- data.frame(live_birth = c(rep("yes", 18),
                                       rep("no", 12))) %>% 
  sample_n(n())
```


$$H_0: p = 0.488$$
$$H_A: p > 0.488$$

Under $H_0, \ \ \hat{p} \approx N\left(p_0, \sqrt{\frac{p_0(1 - p_0)}{n}}\right)$ and the test statistic $$Z = \frac{\hat{p} - p_0}{SE(\hat{p})} \approx N(0,1)$$

So, for $\alpha = 0.01$, we will compare our test statistic $Z$ to the critical value of `qnorm(.995)` = `r round(qnorm(.995),3)`

---

## Hypothesis test for one proportion

.panelset[
.panel[.panel-name[Plot]
```{r, echo = FALSE, warning = FALSE, out.height = "60%"}
crit_value99 <- qnorm(.995)
stat <- prop_test(newclinic, response = live_birth, success = "yes",
          conf_level = 0.99, z = TRUE)$statistic
ggplot() +
  xlim(c(-5,5)) + 
  stat_slab(aes(y = "Z",
                   dist = dist_normal(),
                   fill = after_stat(x < -stat | x > stat)),
               show.legend = FALSE) +
  geom_vline(xintercept = crit_value99, linewidth = 1, linetype = 21,
             color = "navyblue") +
  geom_vline(xintercept = -crit_value99, linewidth = 1, linetype = 21,
             color = "navyblue") +
  annotate("label", label = "0.01 Critical\nValue", 
           x = crit_value99, y = 2, color = "navyblue") +
  annotate("label", label = "0.01 Critical\nValue", 
           x = -crit_value99, y = 2, color = "navyblue") +
    geom_vline(xintercept = stat, linewidth = 1, linetype = 19,
             color = "purple") +
  geom_vline(xintercept = -stat, linewidth = 1, linetype = 19,
             color = "purple") +
  annotate("label", label = "Test\nStatistic", 
           x = -stat, y = 2.25, color = "purple") +
  annotate("label", label = "Test\nStatistic", 
           x = stat, y = 2.25, color = "purple") +
  coord_cartesian(expand = FALSE, ylim = c(0.9, 2.5)) +
  labs(y = "", x = "x") +
  scale_fill_viridis_d() +
  theme_minimal()
```
]
.panel[.panel-name[Calculations]
```{r}
phat <- 0.6
p0 <- 0.488
n <- 30
SE <- sqrt(p0*(1-p0)/n)
(Z <- (phat - p0)/SE)
```
]]


---

# Hypothesis test for one proportion

```{r}
glimpse(newclinic)
prop_test(newclinic, response = live_birth, success = "yes", conf_level = 0.99, z = TRUE, p = 0.488)
```

We FAIL TO REJECT $H_0$ because our `statistic` (1.23) is LESS extreme than our critical value (2.576). Equivalently, our p-value (0.220) is greater than $\alpha = 0.01$. 

That is, there is NOT sufficient evidence to claim the new clinic has a higher success rate. 

---

class: middle

# Case study: Is Cell Shape Associated with Malignancy?

### from Kuiper & Sklar (2013), *Practicing Statistics*

---

## Case study: Is Cell Shape Associated with Malignancy?

*Fine needle aspiration* is a less invasive alternative to a biopsy (surgery) to extract a small sample of a tumor and test for malignancy by visual measurements from a microscope. It is used to assist doctors with the diagnosis of breast cancer. Several measurements are taken such as size, shape, and texture of the cells. 

Below is data collected at the University of Wisconsin on 37 tumors. 

```{r, echo = FALSE}
cell_data <- data.frame(type = c(rep("Benign", 13), rep("Malignant", 24)),
                        shape = c(rep("Round", 9), rep("Concave", 4),
                                  rep("Round", 7), rep("Concave", 17)))
```

```{r}
cell_data %>% 
  count(type, shape)
```

---

## Proportions & risk

The **proportion** of malignant nuclei in this study is 24/37 = `r round(24/37, 4)`

```{r}
cell_data %>% 
  count(type) %>% 
  mutate(prop = n/sum(n))
```

This overall proportion of malignancy is often called the **risk** or **baseline risk**.

---

## Conditional proportions 

The *conditional proportion* is the proportion of malignant cells for each cell shape.

```{r}
cell_data %>% 
  count(type, shape) %>% 
  group_by(shape) %>% 
  mutate(prop = n/sum(n))
```

The round nuclei have a conditional proportion of 7/16 = `r round(7/16, 4)`.

The concave nuclei have a conditional proportion of 17/21 = `r round(17/21, 4)`.

---

## Limitations to analyzing differences in proportions

Consider an example of 2 studies:

**Study 1:**

$$\hat{p}_1 - \hat{p}_2 = 0.52 - 0.48 = 0.04$$

**Study 2:**

$$\hat{p}_1 - \hat{p}_2 = 0.05 - 0.01 = 0.04$$

Both have difference of 0.01, but in Study 2, the proportion in group 1 $\hat{p}_1$ is 5 times as large as the proportion in group 2 $\hat{p}_2$

---

## Relative risk

$$\text{Relative risk } = \frac{\text{proportion of successes in group 1}}{\text{proportion of successes in group 2}} = \frac{\hat{p}_1}{\hat{p}_2}$$
```{r, echo = FALSE}
summary <- cell_data %>% 
  count(type, shape) %>% 
  group_by(shape) %>% 
  mutate(prop = n/sum(n))
phat_1 <- summary %>% filter(type == "Malignant", shape == "Concave") %>% pull(prop)
phat_2 <- summary %>% filter(type == "Malignant", shape == "Round") %>% pull(prop)
```

.pull-left[
In the cell cancer study, the **relative risk** is `r round(phat_1, 4)`/`r round(phat_2, 4)` = `r round(phat_1/phat_2, 4)`

That is, the risk of malignancy is 1.85 times greater for the Concave group than for the Round group.
]

.pull-right[

```{r}
cell_data %>% 
  count(type, shape) %>% 
  group_by(shape) %>% 
  mutate(prop = n/sum(n))
```

]
---

## Odds

The **odds** (of success) can also be used to compare proportions and are commonly used in medicine and the social sciences.

$$\text{Odds } = \frac{\text{number of successes}}{\text{number of failures}}$$
The odds of malignancy in the concave group are 17 to 4, meaning that we expect 17 successes (malignant tumors) for every 4 failures (benign tumors).

*"The odds of malignancy in the concave group are 4.25 to 1"* (17/4 = 4.25)

---

## Odds ratio

$$\text{Odds ratio} = \frac{\text{odds of group 1}}{\text{odds of group 2}} = \frac{\hat{\theta}_1}{\hat{\theta}_2}$$

The odds ratio in the cancer cell study is $\frac{17/4}{7/9} = 5.5$

*The odds of malignancy are 5.5 times greater for the concave group than for the round group*



```{r}
cell_data %>% 
  count(shape, type) 
```

---

## Relative risk & odds ratio 

Relative risk and odds ratio of 1 indicate no difference between the groups.

In relative risk and odds ratio calculations, the group with the lower proportion (or lower odds) is considered group 2 (the denominator). That way, relative risk and odds ratio are always numbers larger than 1 and easier to interpret.

When proportions are far away from 0.5, hypothesis tests (covered later) for proportions.

**Be careful with absolute risk vs. relative risk reduction interpretations** (same concern as % change versus percentage point change)
